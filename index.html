<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>First-Aid Training Suite v3.7</title>

<link rel="manifest" href="/manifest.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* --- Global Variables --- */
:root {
    --font-scale: 1;
    --bg-primary: #f3f4f6;
    --text-primary: #1f2937;
    --op-bg: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
    --op-text: white;
}

body { 
    font-family: 'Inter', sans-serif; 
    touch-action: manipulation; 
    overscroll-behavior-y: none; 
    background-color: var(--bg-primary); 
    color: var(--text-primary);
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
}

/* --- Utilities --- */
.font-scalable { font-size: calc(1rem * var(--font-scale)); }
.scrollbar-hidden::-webkit-scrollbar { display: none; }
.scrollbar-hidden { -ms-overflow-style: none; scrollbar-width: none; }
.fade-in { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- Operator App Specifics --- */
.mic-listening { animation: operatorPulse 1.5s infinite; color: #ef4444; }
@keyframes operatorPulse { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }
.typing-indicator span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #e2e8f0; animation: typing-bounce 1.2s infinite ease-in-out; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

/* --- Scenario App Specifics --- */
.scenario-card { transition: all 0.3s ease; border: 1px solid #e5e7eb; }
.scenario-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #3b82f6; }
.progress-bar { transition: width 0.5s ease-in-out; }

</style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="master-selection-screen" class="flex flex-col items-center justify-center min-h-screen p-6 bg-gray-50 relative z-50">
    <div class="absolute top-4 right-4 text-xs text-gray-400">v3.7.0</div>
    
    <div class="w-full max-w-md text-center space-y-8">
        <div>
            <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 text-blue-600 rounded-2xl mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Training Suite</h1>
            <p class="text-gray-500 mt-2">Choose your training module</p>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <button onclick="AppManager.launchScenarioApp()" class="group relative flex items-center p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 hover:shadow-md transition-all text-left">
                <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center mr-4 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-900">Scenario Simulator</h3>
                    <p class="text-sm text-gray-500">Practice decision making (DR ABC)</p>
                </div>
                <div class="absolute right-4 text-gray-300 group-hover:text-blue-500">‚Üí</div>
            </button>

            <button onclick="AppManager.launchOperatorApp()" class="group relative flex items-center p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:border-green-500 hover:shadow-md transition-all text-left">
                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-4 group-hover:bg-green-600 group-hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-900">999 Operator</h3>
                    <p class="text-sm text-gray-500">Voice-activated call simulation</p>
                </div>
                <div class="absolute right-4 text-gray-300 group-hover:text-green-500">‚Üí</div>
            </button>
        </div>
    </div>
</div>

<div id="scenario-app-wrapper" class="hidden fixed inset-0 bg-gray-100 z-40 flex-col">
    
    <div class="bg-white px-4 py-3 shadow-sm flex justify-between items-center z-10 border-b border-gray-200">
        <div class="flex items-center">
            <button onclick="AppManager.goHome()" class="p-2 mr-2 rounded-full hover:bg-gray-100 text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <h2 class="font-bold text-lg" id="scenario-header-title">Scenarios</h2>
        </div>
        <div id="scenario-score-display" class="hidden bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">
            Score: <span id="current-score">0</span>
        </div>
    </div>

    <div id="scenario-menu" class="flex-grow p-6 overflow-y-auto">
        <h3 class="text-gray-500 text-sm font-bold uppercase tracking-wide mb-4">Available Modules</h3>
        <div class="grid gap-4">
            
            <div onclick="ScenarioApp.loadScenario('collapsed_shopper')" class="scenario-card bg-white p-5 rounded-xl cursor-pointer">
                <div class="flex justify-between items-start mb-2">
                    <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded">Critical</span>
                    <span class="text-gray-400 text-xs">5 Mins</span>
                </div>
                <h4 class="font-bold text-lg mb-1">The Collapsed Shopper</h4>
                <p class="text-gray-500 text-sm mb-3">A man collapses in a supermarket aisle. Apply the DR ABC primary survey protocol.</p>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-gray-300 h-full w-0"></div> </div>
            </div>

            <div onclick="ScenarioApp.loadScenario('garden_accident')" class="scenario-card bg-white p-5 rounded-xl cursor-pointer">
                <div class="flex justify-between items-start mb-2">
                    <span class="bg-orange-100 text-orange-600 text-xs font-bold px-2 py-1 rounded">Trauma</span>
                    <span class="text-gray-400 text-xs">3 Mins</span>
                </div>
                <h4 class="font-bold text-lg mb-1">Garden Accident</h4>
                <p class="text-gray-500 text-sm mb-3">Severe bleeding management following a tool accident. Manage shock and blood loss.</p>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-gray-300 h-full w-0"></div>
                </div>
            </div>
            
        </div>
    </div>

    <div id="scenario-gameplay" class="hidden flex-col flex-grow bg-gray-50 relative overflow-hidden">
        <div id="scenario-content" class="flex-grow overflow-y-auto p-4 space-y-4 pb-32">
            </div>

        <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg pb-safe-area">
            <div id="scenario-options" class="grid gap-3 max-w-2xl mx-auto">
                </div>
        </div>
    </div>

    <div id="scenario-result-modal" class="hidden absolute inset-0 z-50 bg-white/90 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center">
        <div id="result-icon" class="w-24 h-24 rounded-full flex items-center justify-center mb-6 text-5xl shadow-lg">
            üèÜ
        </div>
        <h2 id="result-title" class="text-3xl font-extrabold mb-2 text-gray-900">Scenario Complete</h2>
        <p id="result-message" class="text-gray-600 mb-8 max-w-xs mx-auto">You scored 80 points.</p>
        <button onclick="ScenarioApp.returnToMenu()" class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg w-full max-w-xs">Return to Menu</button>
    </div>

</div>

<div id="operator-app-wrapper" class="hidden fixed top-0 left-0 w-full h-full flex flex-col bg-slate-900 text-white z-40 overflow-hidden">
    <div class="px-4 py-2 bg-slate-800/50 backdrop-blur border-b border-white/10 flex justify-between items-center shrink-0">
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span class="text-xs font-mono text-gray-400">REC: ON</span>
        </div>
        <button onclick="AppManager.goHome()" class="text-xs bg-white/10 px-3 py-1 rounded hover:bg-white/20">Exit</button>
    </div>

    <div id="call-screen" class="flex-grow flex flex-col relative overflow-hidden">
        
        <div id="dialing-ui" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-20">
            <div class="w-32 h-32 rounded-full border border-white/10 flex items-center justify-center mb-8 bg-white/5">
                <span class="text-4xl">üìû</span>
            </div>
            <div class="text-6xl font-light mb-2">999</div>
            <div id="op-status" class="text-green-400 animate-pulse">Connecting...</div>
            <button id="op-start-btn" class="mt-12 bg-green-600 hover:bg-green-500 text-white w-20 h-20 rounded-full flex items-center justify-center shadow-lg shadow-green-900/50 transition transform active:scale-95">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>

        <div id="active-call-ui" class="hidden flex-col h-full w-full max-w-2xl mx-auto">
            <div class="shrink-0 p-4 border-b border-white/5 bg-slate-900/80 backdrop-blur">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-bold text-lg">Emergency Operator</div>
                        <div class="text-xs text-blue-400 font-mono" id="op-timer">00:00</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="OperatorApp.forceScenario('rc_arrest')" class="text-xs bg-red-900/50 text-red-200 border border-red-500/30 px-2 py-1 rounded">‚ö†Ô∏è Cardiac Arrest</button>
                        <button onclick="OperatorApp.toggleTranscript()" class="text-xs bg-slate-700 text-gray-300 px-2 py-1 rounded">üìù Log</button>
                    </div>
                </div>
            </div>

            <div id="op-chat-log" class="flex-grow overflow-y-auto p-4 space-y-4 scrollbar-hidden">
                </div>

            <div class="shrink-0 p-4 pb-8 bg-slate-900 border-t border-white/10">
                <div class="text-center text-xs text-gray-500 mb-2" id="op-mic-status">Tap and hold to speak</div>
                <button id="op-ptt-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold h-16 rounded-2xl flex items-center justify-center space-x-2 transition active:scale-[0.98] shadow-lg shadow-blue-900/20">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    <span>Push to Speak</span>
                </button>
                <div id="op-manual-options" class="mt-2 space-y-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
/* =========================================
   APP MANAGER (Orchestrator)
   ========================================= */
const AppManager = {
    init: function() {
        this.synth = window.speechSynthesis;
        ScenarioApp.init();
        OperatorApp.init();
    },
    launchScenarioApp: function() {
        document.getElementById('master-selection-screen').classList.add('hidden');
        document.getElementById('scenario-app-wrapper').classList.remove('hidden');
        document.getElementById('scenario-app-wrapper').classList.add('flex');
    },
    launchOperatorApp: function() {
        document.getElementById('master-selection-screen').classList.add('hidden');
        document.getElementById('operator-app-wrapper').classList.remove('hidden');
        document.getElementById('operator-app-wrapper').classList.add('flex');
        OperatorApp.start();
    },
    goHome: function() {
        // Reset Views
        document.getElementById('scenario-app-wrapper').classList.add('hidden');
        document.getElementById('scenario-app-wrapper').classList.remove('flex');
        document.getElementById('operator-app-wrapper').classList.add('hidden');
        document.getElementById('operator-app-wrapper').classList.remove('flex');
        document.getElementById('master-selection-screen').classList.remove('hidden');
        
        // Stop Audio/Logic
        OperatorApp.stop();
        ScenarioApp.reset();
        if(this.synth) this.synth.cancel();
    }
};

/* =========================================
   SCENARIO APP LOGIC
   ========================================= */
const ScenarioApp = {
    score: 0,
    currentScenario: null,
    currentNode: null,
    
    // Data Structure for Scenarios
    data: {
        'collapsed_shopper': {
            title: "The Collapsed Shopper",
            startNode: 'start',
            nodes: {
                'start': {
                    text: "You are walking down a supermarket aisle. You see a middle-aged man lying on the floor. He is not moving. What is your first action?",
                    type: 'choice',
                    options: [
                        { text: "Run over and shake him immediately", next: 'fail_danger', score: -10 },
                        { text: "Check for Danger (Look around)", next: 'danger_checked', score: 10 },
                        { text: "Call 999 immediately", next: 'call_premature', score: 0 }
                    ]
                },
                'fail_danger': {
                    text: "FAIL: You rushed in without checking for danger. There was a puddle of water and a live wire from a fallen display. You have been electrocuted.",
                    type: 'end',
                    result: 'fail'
                },
                'call_premature': {
                    text: "The operator asks you if he is breathing. You don't know because you haven't checked. They tell you to go back and check.",
                    type: 'info',
                    next: 'danger_checked',
                    score: -5
                },
                'danger_checked': {
                    text: "The scene looks safe. No wires, no water, no aggressive bystanders. You approach the man. What now?",
                    type: 'choice',
                    options: [
                        { text: "Check Response (Shout & Shake)", next: 'check_response', score: 10 },
                        { text: "Check Pulse immediately", next: 'check_pulse_wrong', score: -5 },
                        { text: "Start CPR immediately", next: 'cpr_premature', score: -10 }
                    ]
                },
                'check_pulse_wrong': {
                    text: "Finding a pulse can be difficult and unreliable for lay-rescuers. It's better to check response and breathing first.",
                    type: 'info',
                    next: 'check_response'
                },
                'cpr_premature': {
                    text: "FAIL: You started chest compressions on a man who was just sleeping. He wakes up in pain and is very angry. Always check response first.",
                    type: 'end',
                    result: 'fail'
                },
                'check_response': {
                    text: "You shout 'Can you hear me?' and gently shake his shoulders. He does not respond. He is Unresponsive. What is the next step in DR ABC?",
                    type: 'choice',
                    options: [
                        { text: "Airway: Head Tilt, Chin Lift", next: 'airway', score: 10 },
                        { text: "Breathing: Look, Listen, Feel", next: 'breathing_blocked', score: -5 },
                        { text: "Circulation: Check hands for warmth", next: 'circ_wrong', score: -5 }
                    ]
                },
                'breathing_blocked': {
                    text: "You try to check breathing, but his tongue might be blocking the airway. You can't tell effectively.",
                    type: 'info',
                    next: 'airway'
                },
                'circ_wrong': {
                    text: "Checking hands isn't a priority right now. Airway is key.",
                    type: 'info',
                    next: 'airway'
                },
                'airway': {
                    text: "You place one hand on his forehead and two fingers under his chin, tilting the head back. The airway is open. Now what?",
                    type: 'choice',
                    options: [
                        { text: "Check Breathing (Look, Listen, Feel)", next: 'check_breathing', score: 10 },
                        { text: "Put him in Recovery Position", next: 'recovery_premature', score: -5 }
                    ]
                },
                'recovery_premature': {
                    text: "Not yet. We don't know if he is breathing. If he isn't, the recovery position is dangerous.",
                    type: 'info',
                    next: 'check_breathing'
                },
                'check_breathing': {
                    text: "You look at his chest, listen at his mouth, and feel for breath on your cheek for 10 seconds. Result: He IS breathing normally.",
                    type: 'choice',
                    options: [
                        { text: "Start CPR", next: 'cpr_breathing_fail', score: -20 },
                        { text: "Recovery Position", next: 'recovery_success', score: 20 },
                        { text: "Leave him to find help", next: 'leave_alone_fail', score: -20 }
                    ]
                },
                'cpr_breathing_fail': {
                    text: "FAIL: Never do CPR on a breathing casualty.",
                    type: 'end',
                    result: 'fail'
                },
                'leave_alone_fail': {
                    text: "FAIL: He vomited while on his back and choked because you left him alone. Use your phone or shout for help, but stay with him.",
                    type: 'end',
                    result: 'fail'
                },
                'recovery_success': {
                    text: "SUCCESS: You placed him in the recovery position to protect his airway. You called 999 and monitored him until the ambulance arrived.",
                    type: 'end',
                    result: 'pass'
                }
            }
        },
        'garden_accident': {
            title: "Garden Accident",
            startNode: 'start',
            nodes: {
                'start': {
                    text: "A neighbour screams. You run over and see he has cut his arm deeply on a rusty saw. Blood is flowing heavily (spurting).",
                    type: 'choice',
                    options: [
                        { text: "Apply direct pressure immediately", next: 'pressure', score: 10 },
                        { text: "Run back to get your first aid kit", next: 'bleeding_out', score: -10 },
                        { text: "Put on gloves first", next: 'gloves_first', score: 5 }
                    ]
                },
                'bleeding_out': {
                    text: "FAIL: In the time you were gone, he lost a critical amount of blood. Pressure must be immediate.",
                    type: 'end',
                    result: 'fail'
                },
                'gloves_first': {
                    text: "Good protection, but be quick. You put on gloves.",
                    type: 'info',
                    next: 'pressure'
                },
                'pressure': {
                    text: "You apply firm direct pressure to the wound using a clean tea towel. The blood is soaking through.",
                    type: 'choice',
                    options: [
                        { text: "Remove the towel and check the wound", next: 'remove_fail', score: -10 },
                        { text: "Add another layer and keep pressing", next: 'layer_up', score: 10 },
                        { text: "Apply a tourniquet immediately", next: 'tourniquet_choice', score: 0 }
                    ]
                },
                'remove_fail': {
                    text: "FAIL: Never remove the dressing. You pulled away the clot that was forming and bleeding increased.",
                    type: 'end',
                    result: 'fail'
                },
                'tourniquet_choice': {
                    text: "A tourniquet is a valid option for catastrophic bleeding, but direct pressure usually works for arm wounds. Let's try pressure first.",
                    type: 'info',
                    next: 'layer_up'
                },
                'layer_up': {
                    text: "You maintain pressure. The bleeding slows. He looks pale and feels cold (Shock).",
                    type: 'choice',
                    options: [
                        { text: "Give him a warm drink", next: 'drink_fail', score: -5 },
                        { text: "Lie him down and raise legs", next: 'shock_pos', score: 10 },
                        { text: "Make him walk inside", next: 'walk_fail', score: -5 }
                    ]
                },
                'drink_fail': {
                    text: "Never give food or drink to a shock victim (they might need surgery).",
                    type: 'info',
                    next: 'shock_pos'
                },
                'walk_fail': {
                    text: "Walking lowers blood pressure to the brain. He faints.",
                    type: 'info',
                    next: 'shock_pos'
                },
                'shock_pos': {
                    text: "SUCCESS: You kept pressure on the wound and treated for shock by lying him down and raising his legs. The ambulance arrives.",
                    type: 'end',
                    result: 'pass'
                }
            }
        }
    },

    init: function() {
        this.dom = {
            menu: document.getElementById('scenario-menu'),
            game: document.getElementById('scenario-gameplay'),
            content: document.getElementById('scenario-content'),
            options: document.getElementById('scenario-options'),
            score: document.getElementById('current-score'),
            scoreContainer: document.getElementById('scenario-score-display'),
            title: document.getElementById('scenario-header-title'),
            modal: document.getElementById('scenario-result-modal')
        };
    },

    loadScenario: function(id) {
        this.currentScenario = this.data[id];
        this.currentNode = this.currentScenario.startNode;
        this.score = 0;
        
        // UI Reset
        this.dom.menu.classList.add('hidden');
        this.dom.game.classList.remove('hidden');
        this.dom.game.classList.add('flex');
        this.dom.scoreContainer.classList.remove('hidden');
        this.dom.title.textContent = this.currentScenario.title;
        this.dom.content.innerHTML = ''; // Clear chat
        this.dom.modal.classList.add('hidden');
        
        this.updateScore(0);
        this.renderNode(this.currentNode);
    },

    renderNode: function(nodeId) {
        const node = this.currentScenario.nodes[nodeId];
        this.currentNode = nodeId;

        // Add Text Bubble
        const bubble = document.createElement('div');
        bubble.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 fade-in mb-4";
        bubble.innerHTML = `<p class="text-lg leading-relaxed">${node.text}</p>`;
        this.dom.content.appendChild(bubble);
        this.dom.content.scrollTop = this.dom.content.scrollHeight;

        // Clear Options
        this.dom.options.innerHTML = '';

        if (node.type === 'end') {
            setTimeout(() => this.showResult(node.result), 1500);
            return;
        }

        if (node.type === 'info') {
            const btn = document.createElement('button');
            btn.className = "w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition";
            btn.textContent = "Continue";
            btn.onclick = () => this.renderNode(node.next);
            this.dom.options.appendChild(btn);
            return;
        }

        // Choice Buttons
        node.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "w-full bg-white text-gray-800 font-medium py-3 px-4 rounded-xl border border-gray-300 hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 transition text-left shadow-sm mb-1";
            btn.textContent = opt.text;
            btn.onclick = () => {
                this.updateScore(opt.score);
                // Add user choice bubble
                const userBubble = document.createElement('div');
                userBubble.className = "bg-blue-600 text-white p-3 rounded-xl rounded-tr-none shadow-sm fade-in mb-4 self-end ml-auto max-w-[80%]";
                userBubble.textContent = opt.text;
                this.dom.content.appendChild(userBubble);
                this.renderNode(opt.next);
            };
            this.dom.options.appendChild(btn);
        });
    },

    updateScore: function(val) {
        if(val) this.score += val;
        this.dom.score.textContent = this.score;
        // Visual feedback
        if(val > 0) this.dom.score.parentElement.classList.add('bg-green-100', 'text-green-800');
        else if(val < 0) this.dom.score.parentElement.classList.add('bg-red-100', 'text-red-800');
        
        setTimeout(() => {
            this.dom.score.parentElement.className = "bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold transition-colors duration-500";
        }, 500);
    },

    showResult: function(result) {
        const modal = this.dom.modal;
        const icon = document.getElementById('result-icon');
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-message');

        modal.classList.remove('hidden');
        
        if (result === 'pass') {
            icon.textContent = "üèÜ";
            icon.className = "w-24 h-24 rounded-full flex items-center justify-center mb-6 text-5xl shadow-lg bg-green-100 text-green-600";
            title.textContent = "Scenario Passed";
            title.className = "text-3xl font-extrabold mb-2 text-green-700";
        } else {
            icon.textContent = "üíÄ";
            icon.className = "w-24 h-24 rounded-full flex items-center justify-center mb-6 text-5xl shadow-lg bg-red-100 text-red-600";
            title.textContent = "Scenario Failed";
            title.className = "text-3xl font-extrabold mb-2 text-red-700";
        }
        msg.textContent = `Final Score: ${this.score} Points`;
    },

    returnToMenu: function() {
        this.dom.modal.classList.add('hidden');
        this.dom.game.classList.add('hidden');
        this.dom.game.classList.remove('flex');
        this.dom.scoreContainer.classList.add('hidden');
        this.dom.menu.classList.remove('hidden');
        this.dom.title.textContent = "Scenarios";
    },

    reset: function() {
        this.returnToMenu();
    }
};

/* =========================================
   OPERATOR APP LOGIC (Simplified for v3.7)
   ========================================= */
const OperatorApp = {
    listening: false,
    timer: null,
    seconds: 0,
    recognition: null,
    synth: window.speechSynthesis,
    currentNode: 'start',

    script: {
        'start': { text: "Emergency Service. Which service do you require?", listen: true, keywords: {'ambulance':'ambulance_connect', 'police':'police_connect', 'fire':'fire_connect'} },
        'ambulance_connect': { text: "Connecting you to Ambulance.", next: 'address_req' },
        'address_req': { text: "Ambulance service. What is the address of the emergency?", listen: true, next: 'address_confirm' },
        'address_confirm': { text: "Thank you. And what is the telephone number you are calling from?", listen: true, next: 'tell_me_problem' },
        'tell_me_problem': { text: "Okay, tell me exactly what has happened.", listen: true, next: 'end_loop' },
        'end_loop': { text: "Okay, help is being arranged. Stay on the line.", listen: false }
    },

    init: function() {
        this.log = document.getElementById('op-chat-log');
        this.status = document.getElementById('op-status');
        this.btnStart = document.getElementById('op-start-btn');
        this.btnPtt = document.getElementById('op-ptt-btn');
        this.micStatus = document.getElementById('op-mic-status');

        this.btnStart.addEventListener('click', () => this.startCall());
        
        // PTT Logic
        this.btnPtt.addEventListener('mousedown', () => this.startListen());
        this.btnPtt.addEventListener('touchstart', (e) => { e.preventDefault(); this.startListen(); });
        this.btnPtt.addEventListener('mouseup', () => this.stopListen());
        this.btnPtt.addEventListener('touchend', (e) => { e.preventDefault(); this.stopListen(); });

        this.setupRecognition();
    },

    startCall: function() {
        document.getElementById('dialing-ui').classList.add('hidden');
        document.getElementById('active-call-ui').classList.remove('hidden');
        document.getElementById('active-call-ui').classList.add('flex');
        this.startTimer();
        this.processNode('start');
    },

    processNode: function(id) {
        this.currentNode = id;
        const node = this.script[id];
        
        // Operator speaks
        this.addBubble(node.text, 'op');
        this.speak(node.text);

        // Auto transition if no listen required
        if (node.next && !node.listen) {
            setTimeout(() => this.processNode(node.next), 3000);
        }
    },

    speak: function(text) {
        if(this.synth.speaking) this.synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-GB';
        u.rate = 1.1;
        this.synth.speak(u);
    },

    setupRecognition: function() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            this.recognition = new SR();
            this.recognition.lang = 'en-GB';
            this.recognition.continuous = false;
            this.recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                this.addBubble(txt, 'user');
                this.handleInput(txt.toLowerCase());
            };
        } else {
            this.addBubble("Speech recognition not supported on this browser.", 'sys');
        }
    },

    startListen: function() {
        if(this.recognition) {
            try { this.recognition.start(); } catch(e){}
            this.btnPtt.classList.add('bg-red-600');
            this.btnPtt.classList.remove('bg-blue-600');
            this.micStatus.textContent = "Listening...";
        }
    },

    stopListen: function() {
        if(this.recognition) {
            try { this.recognition.stop(); } catch(e){}
            this.btnPtt.classList.remove('bg-red-600');
            this.btnPtt.classList.add('bg-blue-600');
            this.micStatus.textContent = "Processing...";
        }
    },

    handleInput: function(text) {
        const node = this.script[this.currentNode];
        let next = node.next;
        
        // Keyword check
        if(node.keywords) {
            for(let k in node.keywords) {
                if(text.includes(k)) next = node.keywords[k];
            }
        }
        
        if(next) setTimeout(() => this.processNode(next), 1000);
    },

    addBubble: function(text, type) {
        const div = document.createElement('div');
        div.className = `p-3 rounded-xl text-sm max-w-[85%] fade-in ${type === 'op' ? 'bg-gray-700 self-start text-white' : (type === 'sys' ? 'bg-yellow-900/50 text-yellow-200 self-center text-center text-xs' : 'bg-blue-600 self-end text-white text-right')}`;
        div.textContent = text;
        
        const wrapper = document.createElement('div');
        wrapper.className = `w-full flex ${type === 'op' ? 'justify-start' : (type === 'sys' ? 'justify-center' : 'justify-end')}`;
        wrapper.appendChild(div);
        
        this.log.appendChild(wrapper);
        this.log.scrollTop = this.log.scrollHeight;
    },

    startTimer: function() {
        this.timer = setInterval(() => {
            this.seconds++;
            const m = Math.floor(this.seconds / 60).toString().padStart(2,'0');
            const s = (this.seconds % 60).toString().padStart(2,'0');
            document.getElementById('op-timer').textContent = `${m}:${s}`;
        }, 1000);
    },

    stop: function() {
        clearInterval(this.timer);
        this.seconds = 0;
        document.getElementById('dialing-ui').classList.remove('hidden');
        document.getElementById('active-call-ui').classList.add('hidden');
        document.getElementById('active-call-ui').classList.remove('flex');
        this.log.innerHTML = '';
        if(this.synth) this.synth.cancel();
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => AppManager.init());

</script>
</body>
</html>