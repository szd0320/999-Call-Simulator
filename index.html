<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>999 Simulator v10.1.1</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
    /* Base Styles */
    :root { --bg-dark: #0f172a; --bg-card: #1e293b; --accent: #3b82f6; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: white; height: 100dvh; overflow: hidden; touch-action: manipulation; }
    
    /* Dial Pad */
    .dial-btn { 
        width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: all 0.1s; border: 1px solid rgba(255,255,255,0.05);
    }
    .dial-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
    .dial-number { font-size: 24px; font-weight: 600; line-height: 1; }
    .dial-alpha { font-size: 10px; color: #94a3b8; letter-spacing: 1px; margin-top: 2px; }
    .dial-call { background: #22c55e !important; border: none; }
    
    /* Chat Bubbles */
    .chat-container { scroll-behavior: smooth; }
    .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; font-size: 0.95rem; animation: slideIn 0.3s ease-out; position: relative; }
    .bubble-op { background: var(--bg-card); color: #e2e8f0; border-bottom-left-radius: 4px; align-self: flex-start; }
    .bubble-user { background: var(--accent); color: white; border-bottom-right-radius: 4px; align-self: flex-end; text-align: right; }
    .bubble-sys { align-self: center; font-size: 0.75rem; color: #94a3b8; background: rgba(255,255,255,0.05); padding: 4px 12px; border-radius: 100px; margin: 16px 0; border: 1px solid rgba(255,255,255,0.05); }

    /* Animations */
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .wave-bar { width: 3px; background: #22c55e; animation: wave 1s ease-in-out infinite; border-radius: 10px; }
    @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 24px; } }
    
    /* Scrollbar Hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
</head>
<body class="flex flex-col">

<div class="h-14 bg-slate-900/90 backdrop-blur border-b border-white/5 flex items-center justify-between px-4 z-20 shrink-0">
    <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse hidden" id="rec-dot"></div>
        <span class="font-mono text-xs text-slate-400" id="header-status">DISCONNECTED</span>
    </div>
    <button onclick="CallSim.reset()" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded text-slate-300 transition">Reset</button>
</div>

<div class="relative flex-grow overflow-hidden bg-slate-950">
    
    <div id="screen-dialer" class="absolute inset-0 z-10 flex flex-col items-center justify-end pb-12 bg-slate-950">
        <div class="w-full px-8 mb-8 text-center">
            <div id="dial-display" class="text-5xl font-light text-white h-16 tracking-wider"></div>
            <div id="dial-feedback" class="text-sm text-red-400 h-6 mt-2 opacity-0 transition-opacity">Number Not Recognised</div>
        </div>
        <div class="grid grid-cols-3 gap-x-6 gap-y-4 mb-8">
            <button class="dial-btn" onclick="Dialer.press('1')"><span class="dial-number">1</span><span class="dial-alpha">&nbsp;</span></button>
            <button class="dial-btn" onclick="Dialer.press('2')"><span class="dial-number">2</span><span class="dial-alpha">ABC</span></button>
            <button class="dial-btn" onclick="Dialer.press('3')"><span class="dial-number">3</span><span class="dial-alpha">DEF</span></button>
            <button class="dial-btn" onclick="Dialer.press('4')"><span class="dial-number">4</span><span class="dial-alpha">GHI</span></button>
            <button class="dial-btn" onclick="Dialer.press('5')"><span class="dial-number">5</span><span class="dial-alpha">JKL</span></button>
            <button class="dial-btn" onclick="Dialer.press('6')"><span class="dial-number">6</span><span class="dial-alpha">MNO</span></button>
            <button class="dial-btn" onclick="Dialer.press('7')"><span class="dial-number">7</span><span class="dial-alpha">PQRS</span></button>
            <button class="dial-btn" onclick="Dialer.press('8')"><span class="dial-number">8</span><span class="dial-alpha">TUV</span></button>
            <button class="dial-btn" onclick="Dialer.press('9')"><span class="dial-number">9</span><span class="dial-alpha">WXYZ</span></button>
            <button class="dial-btn" onclick="Dialer.press('*')"><span class="dial-number text-3xl">*</span></button>
            <button class="dial-btn" onclick="Dialer.press('0')"><span class="dial-number">0</span><span class="dial-alpha">+</span></button>
            <button class="dial-btn" onclick="Dialer.press('#')"><span class="dial-number">#</span></button>
        </div>
        <div class="flex items-center gap-8">
            <button onclick="Dialer.clear()" class="w-16 h-16 flex items-center justify-center text-slate-400 hover:text-white transition">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>
                <span class="sr-only">Delete</span>
            </button>
            <button onclick="Dialer.call()" class="dial-btn dial-call shadow-[0_0_30px_rgba(34,197,94,0.4)]">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.23-.23.33-.55.24-1.01a17.27 17.27 0 00-.56-3.53A.995.995 0 008 4H4a1 1 0 00-1 1c0 9.39 7.61 17 17 17a1 1 0 001-1v-4a1 1 0 00-1.01-1.02z"/></svg>
            </button>
            <button onclick="Dialer.backspace()" class="w-16 h-16 flex items-center justify-center text-slate-400 hover:text-white transition">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5m7 7l-7-7 7-7"/></svg>
                <span class="sr-only">Clear</span>
            </button>
        </div>
    </div>

    <div id="screen-active" class="absolute inset-0 z-0 flex flex-col hidden bg-slate-950">
        <div class="h-12 bg-slate-900 border-b border-white/5 flex items-center justify-center">
            <div class="flex flex-col items-center">
                <span id="call-timer" class="font-mono text-blue-400 text-xs tracking-widest">00:00</span>
                <span id="call-service" class="text-[10px] text-slate-500 uppercase tracking-wide">Emergency Operator</span>
            </div>
        </div>

        <div id="chat-log" class="flex-grow flex flex-col overflow-y-auto p-4 no-scrollbar relative">
            </div>

        <div class="p-4 bg-slate-900 border-t border-white/10 safe-bottom">
            <div id="voice-vis" class="h-8 flex justify-center items-center gap-1 mb-4 opacity-0 transition-opacity">
                <div class="wave-bar" style="animation-delay: 0s"></div>
                <div class="wave-bar" style="animation-delay: 0.1s"></div>
                <div class="wave-bar" style="animation-delay: 0.2s"></div>
                <div class="wave-bar" style="animation-delay: 0.3s"></div>
                <div class="wave-bar" style="animation-delay: 0.4s"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="CallSim.endCall()" class="w-14 h-14 bg-red-500/10 border border-red-500/20 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-500 hover:text-white transition">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.36 7.46 6 12 6s8.66 2.36 11.71 5.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                </button>
                <div class="flex-grow relative">
                    <input type="text" id="manual-input" class="w-full h-14 bg-slate-800 border border-slate-700 rounded-xl px-4 text-white focus:outline-none focus:border-blue-500 transition" placeholder="Speak now or type..." onkeydown="if(event.key === 'Enter') CallSim.handleManualInput()">
                    <button id="mic-btn" class="absolute right-2 top-2 bottom-2 aspect-square bg-slate-700 hover:bg-slate-600 rounded-lg text-white flex items-center justify-center transition" onclick="CallSim.toggleMic()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const Dialer = {
    currentNumber: '',
    press: function(num) {
        if (this.currentNumber.length < 3) { this.currentNumber += num; this.updateDisplay(); }
    },
    backspace: function() { this.currentNumber = this.currentNumber.slice(0, -1); this.updateDisplay(); },
    clear: function() { this.currentNumber = ''; this.updateDisplay(); },
    updateDisplay: function() {
        document.getElementById('dial-display').textContent = this.currentNumber;
        document.getElementById('dial-feedback').style.opacity = '0';
    },
    call: function() {
        const emergencyNumbers = ['999', '112', '911', '000', '111', '110', '119', '100', '101'];
        if (emergencyNumbers.includes(this.currentNumber)) {
            CallSim.initAudio();
            document.getElementById('screen-dialer').classList.add('hidden');
            document.getElementById('screen-active').classList.remove('hidden');
            CallSim.start();
        } else {
            document.getElementById('dial-feedback').style.opacity = '1';
            this.currentNumber = '';
            setTimeout(() => this.updateDisplay(), 1000);
        }
    }
};

const CallSim = {
    synth: window.speechSynthesis,
    recognition: null,
    currentNode: null,
    timerInterval: null,
    seconds: 0,
    voices: [],
    isSpeaking: false,
    isListening: false,
    audioCtx: null,
    metronomeTimer: null,
    encouragementTimer: null,
    cprMinutes: 0,
    
    capturedLocation: "",
    capturedCondition: "",
    calculatedETA: 0,
    isUnresponsive: false, 
    
    script: {
        'start': { text: "Hello, emergency service. Which service do you need?", voice: 'bt_operator', next: 'routing' },
        'routing': { 
            listen: true, 
            keywords: { 'police': 'pol_connect', 'ambulance': 'amb_connect', 'fire': 'fire_connect', 'mountain': 'mt_connect' },
            next: 'amb_connect' 
        },

        /* --- AMBULANCE FLOW --- */
        'amb_connect': { text: "I'll connect you now.", voice: 'bt_operator', next: 'amb_q1_breath' },
        
        // Q1: Breathing
        'amb_q1_breath': { text: "Hello, ambulance service. Is the patient breathing?", voice: 'ambulance', next: 'wait_breath' },
        'wait_breath': { 
            listen: true, 
            keywords: { 
                'no': 'cpr_protocol', 'not breathing': 'cpr_protocol', 'gasping': 'cpr_protocol_agonal',
                'yes': 'amb_q2_awake', 'yeah': 'amb_q2_awake', 'breathing': 'amb_q2_awake' // Added YES
            }, 
            next: 'amb_q2_awake' 
        },

        // Q2: Awake - AVPU Logic Branch
        'amb_q2_awake': { text: "Are they awake?", voice: 'ambulance', next: 'wait_awake' },
        'wait_awake': { 
            listen: true, 
            keywords: { 
                'no': 'mark_unresponsive', 'unconscious': 'mark_unresponsive', 'not responding': 'mark_unresponsive',
                'yes': 'amb_avpu_alert', 'yeah': 'amb_avpu_alert' // Added YES
            },
            next: 'amb_avpu_alert' 
        },
        'mark_unresponsive': { next: 'amb_q3_address', action: 'set_unresponsive' }, 

        // AVPU - Alert
        'amb_avpu_alert': { text: "Are they alert? Can they answer your questions?", voice: 'ambulance', next: 'wait_avpu_a' },
        'wait_avpu_a': {
            listen: true,
            keywords: { 
                'yes': 'amb_q3_address', 'yeah': 'amb_q3_address', 'yep': 'amb_q3_address', // Added YES
                'no': 'amb_avpu_voice', 'confused': 'amb_avpu_voice', 'not really': 'amb_avpu_voice', 'don\'t know': 'amb_avpu_voice' 
            },
            next: 'amb_q3_address' 
        },

        // AVPU - Voice
        'amb_avpu_voice': { text: "Do they react when you talk, even if they cannot talk back?", voice: 'ambulance', next: 'wait_avpu_v' },
        'wait_avpu_v': {
            listen: true,
            keywords: { 
                'no': 'mark_unresponsive',
                'yes': 'amb_q3_address', 'yeah': 'amb_q3_address' // Added YES
            }, 
            next: 'amb_q3_address' 
        },

        // Address & Phone
        'amb_q3_address': { text: "What's the address of the emergency? Where are you?", voice: 'ambulance', next: 'wait_addr' },
        'wait_addr': { listen: true, next: 'amb_q4_phone', capture: 'location' },
        'amb_q4_phone': { text: "What is the telephone number you are calling from?", voice: 'ambulance', next: 'wait_phone' },
        'wait_phone': { listen: true, next: 'amb_q5_happen' },

        // Q5: What Happened
        'amb_q5_happen': { text: "Tell me exactly what has happened.", voice: 'ambulance', next: 'wait_happen' },
        'wait_happen': { 
            listen: true, 
            capture: 'condition',
            keywords: { 
                'diabetes': 'diabetic_check_1', 'diabetic': 'diabetic_check_1', 'insulin': 'diabetic_check_1', 'hypo': 'diabetic_check_1', 'sugar': 'diabetic_check_1',
                // Weather / Temp
                'sun': 'assess_heat', 'heat': 'assess_heat', 'hot': 'assess_heat', 'heatstroke': 'assess_heat', 'sweating': 'assess_heat',
                'hypothermia': 'assess_cold', 'cold': 'assess_cold', 'river': 'assess_cold', 'lake': 'assess_cold', 'water': 'assess_cold', 'rain': 'assess_cold', 'snow': 'assess_cold', 'wind': 'assess_cold', 'freezing': 'assess_cold',
                // Allergy / Anaphylaxis
                'allergy': 'allergy_check', 'allergic': 'allergy_check', 'swelling': 'allergy_check', 'rash': 'allergy_check', 'itchy': 'allergy_check', 'puffy': 'allergy_check', 'sting': 'allergy_check', 'nuts': 'allergy_check', 'reaction': 'allergy_check', 'peanuts': 'allergy_check', 'bee': 'allergy_check',
                // Trauma
                'bleed': 'assess_bleed', 'cut': 'assess_bleed', 'glass': 'assess_bleed', 'knife': 'assess_bleed', 'blood': 'assess_bleed',
                'burn': 'assess_burn', 'fire': 'assess_burn', 'smoke': 'assess_burn',
                'choke': 'assess_choke', 'choking': 'assess_choke', 'food': 'assess_choke', 'swallowed': 'assess_choke', 
                'seizure': 'assess_seizure', 'fitting': 'assess_seizure', 'shaking': 'assess_seizure',
                'fall': 'assess_spinal', 'fell': 'assess_spinal', 'ladder': 'assess_spinal', 'roof': 'assess_spinal', 'tree': 'assess_spinal', 'stairs': 'assess_spinal', 'height': 'assess_spinal', 'back': 'assess_spinal', 'slip': 'assess_spinal', 'trip': 'assess_spinal',
                'chest': 'assess_chest', 'heart': 'assess_chest', 'pain': 'assess_chest'
            }, 
            next: 'amb_s_sample' 
        },

        /* --- ALLERGY PROTOCOL --- */
        'allergy_check': { text: "Help has been arranged. Are they having difficulty breathing, or is there swelling around the mouth or throat?", voice: 'ambulance', next: 'wait_allergy_symptoms' },
        'wait_allergy_symptoms': {
            listen: true,
            keywords: { 
                'yes': 'allergy_severe', 'breathing': 'allergy_severe', 'swollen': 'allergy_severe',
                'no': 'allergy_mild', 'nope': 'allergy_mild' // Added NO
            },
            next: 'allergy_mild'
        },
        'allergy_severe': { text: "This sounds like anaphylaxis. If they have an adrenaline auto-injector or EpiPen, help them use it immediately. Keep them comfortable. I have upgraded the ambulance to top priority.", voice: 'ambulance', action: 'upgrade_to_critical', next: 'amb_s_sample' },
        'allergy_mild': { text: "Monitor them closely. If they are alert and have antihistamines, they can take them. If their breathing changes, tell me immediately.", voice: 'ambulance', next: 'amb_s_sample' },

        /* --- DIABETES PROTOCOL --- */
        'diabetic_check_1': { text: "Help has been arranged and will be there in {ETA} minutes. Are they confused, clammy or aggressive?", voice: 'ambulance', next: 'wait_diabetic_1' },
        'wait_diabetic_1': { 
            listen: true, 
            keywords: { 
                'yes': 'diabetic_check_2', 'yeah': 'diabetic_check_2',
                'no': 'amb_s_sample', 'nope': 'amb_s_sample' // Added NO
            },
            next: 'diabetic_check_2' 
        },
        'diabetic_check_2': { text: "If they are alert and can swallow, give them a sugary drink, glucose gel, or sweets. Do not give them diet drinks.", voice: 'ambulance', next: 'amb_s_sample' },

        /* --- S.A.M.P.L.E (With ETA Insertions) --- */
        'amb_s_sample': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. While we wait, I need to ask a few more questions. How do they look? Are they pale, cold, or in pain?", voice: 'ambulance', next: 'wait_s' },
        'wait_s': { listen: true, next: 'amb_a_sample' },
        
        'amb_a_sample': { text: "Do they have any known allergies?", voice: 'ambulance', next: 'wait_a' },
        'wait_a': { 
            listen: true, 
            keywords: { 'no': 'amb_prompt_tags_a', 'none': 'amb_prompt_tags_a', 'don\'t know': 'amb_prompt_tags_a', 'yes': 'amb_m_sample' }, // Added Yes/No logic
            next: 'amb_m_sample' 
        },
        'amb_prompt_tags_a': { text: "Okay, check their wrists or neck for any medical alert bracelets or tags.", voice: 'ambulance', next: 'amb_m_sample' },

        'amb_m_sample': { text: "Are they taking any medication?", voice: 'ambulance', next: 'wait_m' },
        'wait_m': { 
            listen: true, 
            keywords: { 'no': 'amb_prompt_phone', 'none': 'amb_prompt_phone', 'don\'t know': 'amb_prompt_phone', 'yes': 'amb_p_sample' }, // Added Yes/No
            next: 'amb_p_sample' 
        },
        'amb_prompt_phone': { text: "Please check the emergency contacts or Medical ID on their phone if you can.", voice: 'ambulance', next: 'amb_p_sample' },

        'amb_p_sample': { text: "Do they have any past medical history?", voice: 'ambulance', next: 'wait_p' },
        'wait_p': { 
            listen: true, 
            keywords: { 'no': 'amb_prompt_tags_p', 'none': 'amb_prompt_tags_p', 'don\'t know': 'amb_prompt_tags_p', 'yes': 'amb_l_sample' }, 
            next: 'amb_l_sample' 
        },
        'amb_prompt_tags_p': { text: "Check again for any medical tags or cards in their wallet.", voice: 'ambulance', next: 'amb_l_sample' },

        'amb_l_sample': { text: "When did they last have something to eat or drink?", voice: 'ambulance', next: 'wait_l' },
        'wait_l': { listen: true, next: 'amb_e_sample' },
        
        'amb_e_sample': { text: "What were they doing right before this happened?", voice: 'ambulance', next: 'wait_e' },
        'wait_e': { listen: true, next: 'amb_q6_age' },

        'amb_q6_age': { text: "How old are they?", voice: 'ambulance', next: 'wait_age' },
        'wait_age': { listen: true, next: 'amb_end_monitor' },

        /* --- MONITORING LOOP (Post-Call Support) --- */
        'amb_end_monitor': { 
            text: "Thank you. The ambulance is on its way. I am going to stay on the line with you. Tell me if anything changes.", 
            voice: 'ambulance', 
            next: 'monitoring_mode' 
        },
        'monitoring_mode': {
            listen: true,
            keywords: {
                'snow': 'mon_cold', 'rain': 'mon_cold', 'cold': 'mon_cold', 'shivering': 'mon_cold',
                'sun': 'mon_heat', 'hot': 'mon_heat',
                'diabetes': 'mon_diabetic', 'sugar': 'mon_diabetic', 'insulin': 'mon_diabetic',
                'sick': 'mon_sick', 'vomit': 'mon_sick', 'throw up': 'mon_sick',
                'stopped breathing': 'mon_arrest', 'not breathing': 'mon_arrest', 'arrest': 'mon_arrest', 'died': 'mon_arrest',
                'how long': 'mon_eta', 'eta': 'mon_eta', 'when': 'mon_eta'
            },
            next: 'monitoring_loop_silence' 
        },
        'monitoring_loop_silence': { text: "I am still on the line. Are they still stable?", voice: 'ambulance', next: 'monitoring_mode' }, 

        /* --- MONITORING RESPONSES --- */
        'mon_sick': { text: "Turn them onto their side immediately to clear their airway. Make sure they don't choke.", voice: 'ambulance', next: 'monitoring_mode' },
        'mon_arrest': { text: "Listen carefully. I am updating the ambulance priority to Category 1. We need to start CPR immediately. Get them on their back.", voice: 'ambulance', action: 'upgrade_to_critical', next: 'cpr_instruct' },
        'mon_eta': { text: "Help is on the way. They will be there in {ETA} minutes.", voice: 'ambulance', next: 'monitoring_mode' },
        'mon_diabetic': { text: "If they are becoming confused, do not give them anything more to eat. Turn them on their side if they become unresponsive.", voice: 'ambulance', next: 'monitoring_mode' },
        'mon_cold': { text: "Keep them sheltered and insulated from the ground. If they are awake, give sips of warm sweet drink.", voice: 'ambulance', next: 'monitoring_mode' },
        'mon_heat': { text: "Keep them in the shade. Cool them with fanning or sponging water. If awake, give sips of water.", voice: 'ambulance', next: 'monitoring_mode' },

        'amb_unresponsive_end': { text: "Help has been arranged and we expect them to arrive in {ETA} minutes. Because they are unresponsive, we need to keep their airway open. Gently turn them onto their side. Stay with them. I will stay on the line.", voice: 'ambulance', next: 'monitoring_mode' },

        /* --- CPR / METRONOME --- */
        'cpr_protocol': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Listen carefully. Send someone to get a Defibrillator (AED) immediately if one is nearby. Get them on the floor.", voice: 'ambulance', next: 'cpr_instruct' },
        'cpr_protocol_agonal': { text: "Agonal gasps are NOT normal breathing. This is cardiac arrest. Help is on the way and will be there in {ETA} minutes. Send for a Defibrillator. Get them on the floor.", voice: 'ambulance', next: 'cpr_instruct' },
        'cpr_instruct': { 
            text: "Place the heel of your hand in the center of the chest. Push hard and fast to the beat. Do not stop.", 
            voice: 'ambulance', 
            action: 'start_cpr', 
            next: null 
        },

        /* --- DETAILED PROTOCOLS --- */
        'assess_heat': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Get them out of the sun and into shade. Remove heavy clothing. Sponge them with cool water and fan them. If they are alert, give frequent sips of water.", voice: 'ambulance', next: 'amb_s_sample' },
        
        'assess_cold': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. You must find shelter or a bivi bag. Insulate them from the ground. Replace wet clothing with dry if possible. If they are alert, give warm sweet drinks.", voice: 'ambulance', next: 'amb_s_sample' },

        'assess_bleed': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Is the blood spurting or pumping out?", voice: 'ambulance', next: 'wait_bleed_type' },
        'wait_bleed_type': { 
            listen: true, 
            keywords: { 'yes': 'bleed_catastrophic', 'spurting': 'bleed_catastrophic', 'no': 'bleed_standard', 'nope': 'bleed_standard' }, 
            next: 'bleed_standard' 
        },
        'bleed_catastrophic': { text: "This is a life-threatening bleed. Apply direct pressure immediately. If you have a haemostatic dressing or tourniquet, use it now. Do not release pressure.", voice: 'ambulance', next: 'amb_s_sample' },
        'bleed_standard': { text: "Apply firm direct pressure with a clean cloth. Elevate the limb if possible. Bandage it firmly.", voice: 'ambulance', next: 'amb_s_sample' },
        
        'assess_burn': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Cool the burn with cold running water for at least 20 minutes. Remove jewellery but DO NOT remove clothing stuck to the burn.", voice: 'ambulance', next: 'amb_s_sample' },
        'assess_choke': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Encourage them to cough. If that fails, give 5 back blows between the shoulder blades. If that fails, give 5 abdominal thrusts.", voice: 'ambulance', next: null },
        'assess_seizure': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Do not restrain them. Move dangerous objects away. Protect their head with something soft. Time the seizure.", voice: 'ambulance', next: 'amb_s_sample' },
        'assess_spinal': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Do not move them unless they are in immediate danger. Hold their head still to prevent neck movement.", voice: 'ambulance', next: 'amb_s_sample' },
        'assess_chest': { text: "Help has been arranged and we are expecting them to arrive in {ETA} minutes. Sit them down in a comfortable position (W-position). If they are over 16 and not allergic, give them 300mg of Aspirin to chew.", voice: 'ambulance', next: 'amb_s_sample' },
        
        'pol_connect': { text: "Connecting to Police...", voice: 'bt_operator', next: null },
        'fire_connect': { text: "Connecting to Fire Service...", voice: 'bt_operator', next: null },
        'mt_connect': { text: "Connecting to Mountain Rescue...", voice: 'bt_operator', next: null }
    },

    init: function() {
        window.speechSynthesis.onvoiceschanged = () => { this.voices = window.speechSynthesis.getVoices(); };
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            this.recognition = new SpeechRecognition();
            this.recognition.lang = 'en-GB';
            this.recognition.continuous = false;
            this.recognition.onresult = (e) => this.onRecResult(e);
        }
    },

    initAudio: function() {
        if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
    },

    start: function() {
        this.initAudio();
        this.addBubble("Dialing...", 'sys');
        setTimeout(() => {
            this.startTimer();
            document.getElementById('header-status').textContent = "CONNECTED";
            document.getElementById('header-status').className = "font-mono text-xs text-green-500 animate-pulse";
            this.runNode('start');
        }, 1500);
    },

    runNode: function(id) {
        this.currentNode = this.script[id];
        if (!this.currentNode) return;

        // Logic Flags
        if (this.currentNode.action === 'set_unresponsive') {
            this.isUnresponsive = true;
            this.runNode(this.currentNode.next);
            return;
        }
        if (this.currentNode.action === 'upgrade_to_critical') {
            this.calculateETAValue(true);
        }

        if (this.currentNode.text) {
            let textToSpeak = this.currentNode.text;
            if (textToSpeak.includes('{ETA}')) {
                if(!this.calculatedETA || this.currentNode.action === 'upgrade_to_critical') {
                    this.calculateETAValue();
                }
                textToSpeak = textToSpeak.replace('{ETA}', this.calculatedETA);
            }

            this.addBubble(textToSpeak, 'op');
            this.speak(textToSpeak, this.currentNode.voice, () => {
                if (this.currentNode.action === 'start_cpr') this.startCPR();
                if (this.currentNode.next) this.runNode(this.currentNode.next);
            });
        } else if (this.currentNode.listen) {
            this.startListening();
        }
    },

    speak: function(text, voiceType, callback) {
        this.isSpeaking = true;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-GB';
        
        let targetVoice = null;
        const allVoices = this.voices.length ? this.voices : window.speechSynthesis.getVoices();
        if (voiceType === 'bt_operator') {
            targetVoice = allVoices.find(v => v.name.includes('Female') || v.name.includes('Samantha'));
            u.pitch = 1.2; u.rate = 1.1;
        } else if (voiceType === 'ambulance') {
            targetVoice = allVoices.find(v => v.name.includes('Male') || v.name.includes('Daniel'));
            u.pitch = 0.9; u.rate = 1.0;
        } else if (voiceType === 'police') {
            targetVoice = allVoices.find(v => v.name.includes('Karen')); 
            u.pitch = 1.0; u.rate = 1.05;
        }
        
        if (targetVoice) u.voice = targetVoice;
        u.onend = () => { this.isSpeaking = false; setTimeout(callback, 500); };
        this.synth.speak(u);
    },

    startCPR: function() {
        this.initAudio();
        
        this.metronomeTimer = setInterval(() => {
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            osc.frequency.value = 1000;
            gain.gain.value = 0.1;
            osc.start(this.audioCtx.currentTime);
            osc.stop(this.audioCtx.currentTime + 0.1);
        }, 500);

        this.cprMinutes = 0;
        this.encouragementTimer = setInterval(() => {
            this.cprMinutes++;
            let timeLeft = Math.max(1, this.calculatedETA - this.cprMinutes);
            const messages = [
                `You are doing well. I know this is tiring, but keep it up. We are almost with you.`,
                `Don't stop. You are keeping them alive. Help will be there in ${timeLeft} minutes.`,
                `I am still here with you. Keep pushing to the beat. Doing great.`,
                `Stay strong. The ambulance is getting closer. Keep going.`
            ];
            const msg = messages[(this.cprMinutes - 1) % messages.length];
            this.speak(msg, 'ambulance', () => {}); 
        }, 60000); 
    },

    stopCPR: function() {
        clearInterval(this.metronomeTimer);
        clearInterval(this.encouragementTimer);
    },

    startListening: function() {
        this.isListening = true;
        document.getElementById('manual-input').placeholder = "Listening... (Speak now)";
        document.getElementById('voice-vis').style.opacity = '1';
        document.getElementById('mic-btn').classList.add('bg-red-500');
        try { this.recognition.start(); } catch(e){}
    },

    stopListening: function() {
        this.isListening = false;
        document.getElementById('manual-input').placeholder = "Type or tap Mic";
        document.getElementById('voice-vis').style.opacity = '0';
        document.getElementById('mic-btn').classList.remove('bg-red-500');
        try { this.recognition.stop(); } catch(e){}
    },

    onRecResult: function(e) { const txt = e.results[0][0].transcript; this.handleInput(txt); },
    handleManualInput: function() {
        const input = document.getElementById('manual-input');
        if (input.value.trim()) { this.handleInput(input.value.trim()); input.value = ''; }
    },

    handleInput: function(text) {
        this.stopListening();
        this.addBubble(text, 'user');
        const lower = text.toLowerCase();

        // Manual ETA Check
        if (lower.includes('how long') || lower.includes('eta')) {
            this.calculateETAValue(); 
            const msg = `Help has been arranged. We are expecting them to arrive in ${this.calculatedETA} minutes.`;
            this.addBubble(msg, 'op');
            this.speak(msg, 'ambulance', () => {
                setTimeout(() => this.startListening(), 1000); 
            });
            return;
        }

        if (this.currentNode && this.currentNode.listen) {
            if (this.currentNode.capture === 'location') this.capturedLocation = lower;
            if (this.currentNode.capture === 'condition') this.capturedCondition = lower;

            let nextId = this.currentNode.next;
            let matched = false;
            
            if (this.currentNode.keywords) {
                for (let k in this.currentNode.keywords) {
                    if (lower.includes(k)) { 
                        nextId = this.currentNode.keywords[k]; 
                        matched = true;
                        break; 
                    }
                }
            } else {
                matched = true; // No keywords required, any input proceeds
            }

            // SMART LOGIC: If Unresponsive flag is set, skip SAMPLE logic
            // If the next logical step is SAMPLE, hijack it.
            if (this.isUnresponsive && (nextId === 'amb_s_sample' || nextId === 'diabetic_check_1')) {
                nextId = 'amb_unresponsive_end';
            }

            if (matched) {
                setTimeout(() => this.runNode(nextId), 500);
            } else {
                // Fallback for silence/unmatched input
                this.speak("I didn't catch that. Could you say that again?", this.currentNode.voice, () => {
                    this.startListening();
                });
            }
        }
    },

    calculateETAValue: function(forceRecalculate = false) {
        const loc = this.capturedLocation || "";
        const cond = this.capturedCondition || "";
        const remoteKeywords = ['hill', 'river', 'mountain', 'forest', 'lake', 'wood', 'park'];
        const criticalKeywords = ['spinal', 'spine', 'back', 'neck', 'breathing', 'heart', 'stroke', 'arrest', 'cpr', 'unresponsive', 'unconscious', 'bleed', 'burn', 'choke', 'seizure', 'allergy', 'anaphylaxis'];
        
        let isRemote = remoteKeywords.some(k => loc.includes(k));
        let isCritical = criticalKeywords.some(k => cond.includes(k)) || this.isUnresponsive;
        
        if (this.currentNode === this.script['cpr_protocol'] || this.currentNode === this.script['cpr_protocol_agonal']) {
            isCritical = true;
        }
        
        let minTime = 8, maxTime = 20;

        if (isRemote) {
            if (isCritical) { 
                minTime = 10; maxTime = 25; 
            } else { 
                minTime = 120; maxTime = 180; 
            }
        } else {
            if (!isCritical) { minTime = 30; maxTime = 90; } 
        }

        if (!this.calculatedETA || forceRecalculate) {
            this.calculatedETA = Math.floor(Math.random() * (maxTime - minTime + 1)) + minTime;
        } else if (isCritical && this.calculatedETA > 30) {
            this.calculatedETA = Math.floor(Math.random() * (maxTime - minTime + 1)) + minTime;
        }

        return this.calculatedETA;
    },

    addBubble: function(text, type) {
        const log = document.getElementById('chat-log');
        const div = document.createElement('div');
        div.className = `bubble bubble-${type}`;
        div.textContent = text;
        log.appendChild(div);
        div.scrollIntoView({ behavior: 'smooth' });
    },

    startTimer: function() {
        this.timerInterval = setInterval(() => {
            this.seconds++;
            const m = String(Math.floor(this.seconds/60)).padStart(2,'0');
            const s = String(this.seconds%60).padStart(2,'0');
            document.getElementById('call-timer').textContent = `${m}:${s}`;
        }, 1000);
    },

    endCall: function() {
        clearInterval(this.timerInterval);
        this.stopCPR();
        this.synth.cancel();
        this.stopListening();
        this.addBubble("Call Terminated", 'sys');
        document.getElementById('header-status').textContent = "DISCONNECTED";
        document.getElementById('header-status').className = "font-mono text-xs text-red-500";
    },

    reset: function() { window.location.reload(); },
    toggleMic: function() { if(this.isListening) this.stopListening(); else this.startListening(); }
};

CallSim.init();
</script>
</body>
</html>